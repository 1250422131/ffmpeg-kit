name: android aar build

on:
  workflow_dispatch:
    inputs:
      build_mode:
        description: 'Build mode (min, https, audio, video, full)'
        required: true
        default: 'full'
        type: choice
        options:
          - min
          - https
          - audio
          - video
          - full
      enable_16kb:
        description: 'Enable 16KB page size support'
        required: false
        default: false
        type: boolean
      enable_gpl:
        description: 'Enable GPL libraries'
        required: false
        default: false
        type: boolean
      ndk_version:
        description: 'Android NDK version'
        required: false
        default: 'r25b-linux'
        type: choice
        options:
          - r22b-linux-x86_64
          - r23b-linux
          - r24-linux
          - r25b-linux

jobs:
  build-aar:
    name: Build Android AAR - ${{ inputs.build_mode }}
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'adopt'
          java-version: '17'
      
      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool pkg-config curl git doxygen nasm cmake gcc gperf texinfo yasm bison autogen wget autopoint meson ninja-build ragel groff gtk-doc-tools libtasn1-bin
      
      - name: Clean up CMake
        run: ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --uninstall "cmake;3.10.2.4988404" "cmake;3.18.1"
      
      - name: Upgrade meson
        run: pip install meson --upgrade
      
      - name: Set up Android NDK
        run: |
          curl -s "https://dl.google.com/android/repository/android-ndk-${{ inputs.ndk_version }}.zip" -o ndk.zip
          unzip -q -o ndk.zip -d .ndk
          echo "ANDROID_NDK_ROOT=$PWD/.ndk/$(ls .ndk)" >> $GITHUB_ENV
      
      - name: Prepare build options
        id: build_opts
        run: |
          BUILD_OPTS=""
          
          # Add build mode libraries
          case "${{ inputs.build_mode }}" in
            min)
              # Min build - no external libraries
              ;;
            https)
              BUILD_OPTS="--enable-gnutls"
              ;;
            audio)
              BUILD_OPTS="--enable-lame --enable-libilbc --enable-libvorbis --enable-opencore-amr --enable-opus --enable-shine --enable-soxr --enable-speex --enable-twolame --enable-vo-amrwbenc --enable-wavpack"
              ;;
            video)
              BUILD_OPTS="--enable-fontconfig --enable-freetype --enable-fribidi --enable-kvazaar --enable-libaom --enable-libass --enable-libtheora --enable-libvpx --enable-snappy"
              ;;
            full)
              BUILD_OPTS="--full"
              ;;
          esac
          
          # Add GPL flag if requested
          if [[ "${{ inputs.enable_gpl }}" == "true" ]]; then
            BUILD_OPTS="$BUILD_OPTS --enable-gpl"
          fi
          
          # Add 16KB page size support if requested
          if [[ "${{ inputs.enable_16kb }}" == "true" ]]; then
            BUILD_OPTS="$BUILD_OPTS --enable-16kb-page-size"
          fi
          
          echo "build_opts=$BUILD_OPTS" >> $GITHUB_OUTPUT
          echo "Build options: $BUILD_OPTS"
      
      - name: Run build script
        run: ./android.sh ${{ steps.build_opts.outputs.build_opts }} --disable-arm-v7a
      
      - name: Print build logs
        if: ${{ always() }}
        run: cat build.log
      
      - name: Print ffbuild logs
        if: ${{ failure() }}
        run: '[[ -f ./src/ffmpeg/ffbuild/config.log ]] && tail -50 ./src/ffmpeg/ffbuild/config.log'
      
      - name: Find AAR file
        id: find_aar
        if: success()
        run: |
          AAR_FILE=$(find prebuilt -name "ffmpeg-kit.aar" -type f | head -n 1)
          if [[ -z "$AAR_FILE" ]]; then
            echo "AAR file not found!"
            exit 1
          fi
          echo "aar_path=$AAR_FILE" >> $GITHUB_OUTPUT
          echo "Found AAR: $AAR_FILE"
          
          # Determine AAR name based on build configuration
          AAR_NAME="ffmpeg-kit-${{ inputs.build_mode }}"
          if [[ "${{ inputs.enable_16kb }}" == "true" ]]; then
            AAR_NAME="${AAR_NAME}-16kb"
          fi
          if [[ "${{ inputs.enable_gpl }}" == "true" ]]; then
            AAR_NAME="${AAR_NAME}-gpl"
          fi
          AAR_NAME="${AAR_NAME}.aar"
          echo "aar_name=$AAR_NAME" >> $GITHUB_OUTPUT
          echo "AAR will be uploaded as: $AAR_NAME"
      
      - name: Upload AAR artifact
        if: success()
        uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.find_aar.outputs.aar_name }}
          path: ${{ steps.find_aar.outputs.aar_path }}
          retention-days: 30
      
      - name: Create build summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Mode**: ${{ inputs.build_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "- **16KB Page Size**: ${{ inputs.enable_16kb }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GPL Enabled**: ${{ inputs.enable_gpl }}" >> $GITHUB_STEP_SUMMARY
          echo "- **NDK Version**: ${{ inputs.ndk_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… AAR file successfully built and uploaded as artifact" >> $GITHUB_STEP_SUMMARY
          fi
